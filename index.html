<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAY2DAY | Faraz Samie</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body>

    <!-- BOTTOM RIGHT COUNTDOWNS -->
    <div class="countdown-wrapper">
        <div class="countdown-box" id="countApr3">
            <div class="countdown-label">APRIL 3RD, 2026</div>
            <div class="countdown-time" id="countdown1">Loading..</div>
        </div>

        <div class="countdown-box" id="countNextMonth">
            <div class="countdown-label">3RD OF NEXT MONTH</div>
            <div class="countdown-time" id="countdown2">Loading..</div>
        </div>
    </div>

    <!-- BOTTOM LEFT BUTTONS -->
    <div class="controls-wrapper">
        <button class="btn btn-green" onclick="exportToExcel()">Excel</button>
        <button class="btn btn-indigo" onclick="switchToTimebox()">Time Boxing</button>
        <button class="btn btn-red" onclick="clearAllData()">Clear</button>
    </div>


    <div id="timerView" class="container">

        <h1 class="title"></h1>

        <div class="main-grid">

            <!-- STOPWATCH -->
            <div class="card">
                <h2 class="card-title">Break Time</h2>

                <div class="time-display">
                    <div class="time-main" id="stopwatchDisplay">00:00.00</div>
                </div>

                <div style="text-align:center;margin-bottom:1rem;">
                    <label class="form-label">Break Activity</label>
                    <input type="text" id="breakInput" placeholder=" Insert" style="width:100%;padding:0.5rem;background:#1f2937;color:#f3f4f6;border:1px solid #374151;border-radius:4px;margin-top:0.5rem;">
                </div>

                <div class="button-group">
                    <button id="stopwatchStart" class="btn btn-green" onclick="startStopwatch()"> start</button>
                    <button id="stopwatchPause" class="btn btn-yellow hidden" onclick="pauseStopwatch()"> pause</button>
                    <button class="btn btn-gray" onclick="resetStopwatch()">reset</button>
                </div>
            </div>

            <!-- TIMER -->
            <div class="card">
                <h2 class="card-title">Deep Focus</h2>

                <label class="form-label">Category</label>
                <select id="categorySelect">
                    <option value="ISLAM">Islam</option>
                    <option value="CAREER">Career</option>
                    <option value="HEALTH">Health</option>
                    <option value="ASSETS">Assets</option>
                    <option value="INTERESTS">Interests</option>
                </select>

                <label class="form-label">Description</label>
                <input type="text" id="taskInput" placeholder=" Insert">

                <div class="time-display">
                    <div class="time-main" id="timerDisplay">00:00</div>
                    <div id="currentTask" class="hidden"></div>
                    <div id="timerFinished" class="hidden" style="color:#f87171;font-weight:600;margin-top:6px;">
                        Cutoff Time
                    </div>
                </div>

                <div class="timer-inputs">
                    <label>minutes</label>
                    <input type="number" id="timerMinutes" min="0" max="59" value="5">
                    <label>seconds</label>
                    <input type="number" id="timerSeconds" min="0" max="59" value="0">
                </div>

                <div class="button-group">
                    <button id="timerStart" class="btn btn-green" onclick="startTimer()"> start</button>
                    <button id="timerPause" class="btn btn-yellow hidden" onclick="pauseTimer()"> pause</button>
                    <button class="btn btn-gray" onclick="resetTimer()">reset</button>
                </div>
                
                <div class="button-group" style="display:flex;gap:8px;margin-top:12px;align-items:center;">
                    <input type="number" id="taskRating" min="0" max="10" placeholder="Rate 0-10" style="flex:1;padding:8px;background:#312D2A;color:#EBE0D7;border:1px solid #374151;border-radius:4px;">
                    <button class="btn" style="background:#312D2A;color:#EBE0D7;flex:0 0 120px;border:1px solid #374151;" onclick="completeTask()">completed</button>
                </div>
            </div>

            <!-- FOCUS HISTORY -->
            <div class="card">
                <h2 class="card-title"> History</h2>
                
                <!-- Timeline Graph -->
                <div style="margin-bottom: 20px;">
                    <canvas id="timelineCanvas" width="800" height="300" style="width: 100%; max-width: 800px; border:none;"></canvas>
                </div>
                
                <div id="historyContainer" class="history-container"></div>
            </div>

        </div>
    </div>


    <!-- TIMEBOX VIEW -->
    <div id="timeboxView" class="hidden container">
        <h1>Time Boxing</h1>
        <div id="timeSlotsContainer"></div>
    </div>


<script>
/* GLOBAL STATE */
let stopwatchTime = 0;
let isStopwatchRunning = false;
let stopwatchInterval = null;

let timerTime = 0;
let originalTimerTime = 0;
let isTimerRunning = false;
let isTimerFinished = false;
let timerInterval = null;
let currentTask = '';
let currentCategory = '';

let focusHistory = [];
let expandedDays = {};
let expandedPrayerTimes = {};
let currentView = 'timer';

const categories = ['ISLAM','CAREER','HEALTH','ASSETS','INTERESTS'];

/* PRAYER TIME CALCULATION */
function getPrayerTimePeriod(hour) {
    if (hour >= 4 && hour < 7) return 'Fajr';
    if (hour >= 7 && hour < 11) return 'Post Fajr';
    if (hour >= 11 && hour < 15) return 'Dhuhr';
    if (hour >= 15 && hour < 18) return 'Asr';
    if (hour >= 18 && hour < 20) return 'Maghrib';
    return 'Isha';
}

/* FORMATTERS */
function formatTime(cs) {
    const total = Math.floor(cs/100);
    const m = Math.floor(total/60);
    const s = total%60;
    const c = cs%100;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${c.toString().padStart(2,'0')}`;
}
function formatTimerTime(sec) {
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
function formatFocusTime(cs) {
    const total = Math.floor(cs/100);
    return `${Math.floor(total/60)}m ${total%60}s`;
}

/* BEEP SOUND */
function playCompletionSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();

        function playOne(delay) {
            setTimeout(() => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                const filter = ctx.createBiquadFilter();

                osc.type = "sine";
                osc.frequency.value = 160;

                filter.type = "lowpass";
                filter.frequency.value = 600;

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);

                gain.gain.setValueAtTime(0.001, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.28, ctx.currentTime + 0.35);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.0);

                osc.start();
                osc.stop(ctx.currentTime + 2.0);
            }, delay);
        }

        playOne(0);
        playOne(950);

    } catch (e) {}
}


/* STOPWATCH */
function startStopwatch(){
    isStopwatchRunning = true;
    document.getElementById('stopwatchStart').classList.add('hidden');
    document.getElementById('stopwatchPause').classList.remove('hidden');
    stopwatchInterval = setInterval(()=>{
        stopwatchTime++;
        document.getElementById('stopwatchDisplay').textContent = formatTime(stopwatchTime);
    },10);
}
function pauseStopwatch(){
    isStopwatchRunning = false;
    document.getElementById('stopwatchStart').classList.remove('hidden');
    document.getElementById('stopwatchPause').classList.add('hidden');
    clearInterval(stopwatchInterval);
}
function resetStopwatch(){
    stopwatchTime=0; isStopwatchRunning=false;
    document.getElementById('stopwatchDisplay').textContent=formatTime(0);
    document.getElementById('stopwatchStart').classList.remove('hidden');
    document.getElementById('stopwatchPause').classList.add('hidden');
    clearInterval(stopwatchInterval);
}

/* TIMER */
let timerStartTime=null;
let timerPausedTime=0;

function startTimer(){
    const task=document.getElementById('taskInput');
    const cat=document.getElementById('categorySelect');
    const min=document.getElementById('timerMinutes');
    const sec=document.getElementById('timerSeconds');

    if(timerTime===0 && task.value.trim()){
        const total=+min.value*60 + +sec.value;
        if(total===0){ alert("Set a non-zero timer"); return; }

        timerTime = originalTimerTime = total;
        currentTask = task.value;
        currentCategory = cat.value;
        timerPausedTime = 0;

        const ct=document.getElementById('currentTask');
        ct.innerHTML = `
            <div class="category-badge cat-${currentCategory.toLowerCase().replace(' ','')}">${currentCategory}</div>
            <div>Working on: ${currentTask}</div>`;
        ct.classList.remove('hidden');

        task.disabled = true;
        cat.disabled = true;
        min.disabled = true;
        sec.disabled = true;
    }

    if(!task.value.trim()){ alert("Enter task description"); return; }

    timerStartTime = Date.now();
    isTimerRunning = true;
    isTimerFinished = false;
    document.getElementById('timerStart').classList.add('hidden');
    document.getElementById('timerPause').classList.remove('hidden');
    document.getElementById('timerFinished').classList.add('hidden');

    timerInterval = setInterval(()=>{
        const now = Date.now();
        const elapsed = Math.floor((now - timerStartTime + timerPausedTime)/1000);
        const remain = Math.max(0, originalTimerTime - elapsed);

        timerTime = remain;
        document.getElementById('timerDisplay').textContent = formatTimerTime(remain);

        if(remain<=0){
            clearInterval(timerInterval);
            isTimerRunning=false;
            isTimerFinished=true;
            document.getElementById('timerFinished').classList.remove('hidden');
            playCompletionSound();
        }
    },100);
}

function pauseTimer(){
    if(isTimerRunning && timerStartTime){
        timerPausedTime += Date.now() - timerStartTime;
    }
    isTimerRunning=false;
    document.getElementById('timerStart').classList.remove('hidden');
    document.getElementById('timerPause').classList.add('hidden');
    clearInterval(timerInterval);
}

function resetTimer(){
    isTimerRunning=false;
    timerTime=0;
    originalTimerTime=0;
    currentTask='';
    currentCategory='';
    timerStartTime=null;
    timerPausedTime=0;

    document.getElementById('timerStart').classList.remove('hidden');
    document.getElementById('timerPause').classList.add('hidden');
    document.getElementById('timerDisplay').textContent='00:00';
    document.getElementById('currentTask').classList.add('hidden');
    document.getElementById('timerFinished').classList.add('hidden');

    ['taskInput','categorySelect','timerMinutes','timerSeconds']
    .forEach(id=>document.getElementById(id).disabled=false);

    clearInterval(timerInterval);
}

/* COMPLETE TASK */
function completeTask(){
    const taskName = document.getElementById('taskInput').value.trim();
    const rating = parseInt(document.getElementById('taskRating').value);
    
    if(!taskName){
        alert("Enter a task name to mark as completed");
        return;
    }
    
    if(isNaN(rating) || rating < 0 || rating > 10){
        alert("Please enter a rating between 0 and 10");
        return;
    }
    
    const focusCS = (originalTimerTime - timerTime)*100 - stopwatchTime;
    const nowObj = new Date();

    focusHistory.push({
        task: currentTask || taskName,
        category: currentCategory || document.getElementById('categorySelect').value,
        timerTime: originalTimerTime,
        stopwatchTime,
        focusTime: Math.max(0, focusCS),
        timestamp: nowObj.toISOString(),
        prayerTime: getPrayerTimePeriod(nowObj.getHours()),
        rating: rating,
        taskCompleted: true
    });

    playCompletionSound();
    document.getElementById('taskRating').value = '';
    resetTimer();
    renderHistory();
}

/* CATEGORY COLORS */
function getCategoryClass(cat){
    return {
        "ISLAM":"cat-islam",
        "CAREER":"cat-career",
        "HEALTH":"cat-health",
        "ASSETS":"cat-assets",
        "INTERESTS":"cat-interests"
    }[cat] || "cat-islam";
}

/* HISTORY */
function groupFocusHistory(){
    const out={};
    focusHistory.forEach(x=>{
        const d=new Date(x.timestamp).toDateString();
        const p=x.prayerTime;
        if(!out[d]) out[d]={};
        if(!out[d][p]) out[d][p]=[];
        out[d][p].push(x);
    });
    return out;
}

function calculatePrayerTimeTotals(arr){
    return arr.reduce((a,x)=>{
        a.focusTime+=x.focusTime;
        a.unfocusTime+=x.stopwatchTime;
        return a;
    },{focusTime:0,unfocusTime:0});
}

function toggleDayExpansion(day){
    expandedDays[day]=!expandedDays[day];
    renderHistory();
}

function togglePrayerTimeExpansion(day,pt){
    const key=`${day}-${pt}`;
    expandedPrayerTimes[key]=!expandedPrayerTimes[key];
    renderHistory();
}

/* DRAW TIMELINE GRAPH */
function drawTimelineGraph(){
    const canvas = document.getElementById('timelineCanvas');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas - custom color
    ctx.fillStyle = '#312D2A';
    ctx.fillRect(0, 0, width, height);
    
    // Get today's sessions with ratings
    const today = new Date().toDateString();
    const todaySessions = focusHistory.filter(e => 
        new Date(e.timestamp).toDateString() === today && e.rating !== undefined
    ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    if(todaySessions.length === 0){
        ctx.fillStyle = '#EBE0D7';
        ctx.font = '14px Trebuchet MS';
        ctx.textAlign = 'center';
        ctx.fillText('No sessions today', width/2, height/2);
        return;
    }
    
    // Draw labels
    ctx.strokeStyle = '#EBE0D7';
    ctx.fillStyle = '#EBE0D7';
    ctx.font = '11px Trebuchet MS';
    
    const padding = 40;
    const graphWidth = width - padding * 2;
    const graphHeight = height - padding * 2;
    
    // Vertical time labels (every hour)
    ctx.textAlign = 'center';
    for(let hour = 0; hour <= 24; hour++){
        const x = padding + (hour / 24) * graphWidth;
        
        // Format time in 12-hour format
        let displayHour = hour % 12;
        if(displayHour === 0) displayHour = 12;
        const ampm = hour < 12 ? 'AM' : 'PM';
        
        ctx.fillText(`${displayHour}${ampm}`, x, height - 10);
    }
    
    // Y-axis labels (ratings 0-10)
    ctx.textAlign = 'right';
    for(let i = 0; i <= 10; i++){
        const y = padding + graphHeight - ((i / 10) * graphHeight);
        ctx.fillText(i.toString(), padding - 10, y + 4);
    }
    
    // Draw line connecting dots
    if(todaySessions.length > 1){
        ctx.beginPath();
        ctx.strokeStyle = '#EBE0D7';
        ctx.lineWidth = 2;
        
        todaySessions.forEach((session, index) => {
            const sessionDate = new Date(session.timestamp);
            const startHour = sessionDate.getHours() + sessionDate.getMinutes() / 60;
            
            const x = padding + (startHour / 24) * graphWidth;
            const y = padding + graphHeight - ((session.rating / 10) * graphHeight);
            
            if(index === 0){
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
    }
    
    // Draw dots for each session
    todaySessions.forEach(session => {
        const sessionDate = new Date(session.timestamp);
        const startHour = sessionDate.getHours() + sessionDate.getMinutes() / 60;
        
        const x = padding + (startHour / 24) * graphWidth;
        const y = padding + graphHeight - ((session.rating / 10) * graphHeight);
        
        ctx.fillStyle = '#EBE0D7';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
    });
}

/* RENDER HISTORY */
function renderHistory(){
    const cont=document.getElementById('historyContainer');
    
    // Draw timeline graph
    drawTimelineGraph();
    
    if(focusHistory.length===0){
        cont.innerHTML="<p>No Current Inputs</p>";
        return;
    }

    const grouped = groupFocusHistory();
    const days = Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a));

    let html="";

    days.forEach(day=>{
        const exp = expandedDays[day];
        html += `
            <div class="day-group">
                <button onclick="toggleDayExpansion('${day}')" class="btn btn-gray" style="border:none;background:#312D2A;color:#EBE0D7;">${day}</button>
        `;

        if(exp){
            Object.entries(grouped[day]).forEach(([pt,entries])=>{
                const totals = calculatePrayerTimeTotals(entries);
                const key=`${day}-${pt}`;
                const exp2 = expandedPrayerTimes[key];

                html += `
                    <div style="margin:10px 0;">
                        <button onclick="togglePrayerTimeExpansion('${day}','${pt}')" class="btn" style="background:#312D2A;color:#EBE0D7;">
                            ${pt} (${entries.length}) — Focus: ${formatFocusTime(totals.focusTime)}
                        </button>
                `;

                if(exp2){
                    entries.forEach(e=>{
                        const completedBadge = e.taskCompleted ? ' ✓ COMPLETED' : '';
                        const ratingDisplay = e.rating !== undefined ? ` | Rating: ${e.rating}/10` : '';
                        html += `
                            <div style="margin:6px 0; padding:8px; background:#1f2937;">
                                <span class="category-badge ${getCategoryClass(e.category)}">${e.category}</span>
                                <strong>${e.task}</strong>${completedBadge}<br>
                                Timer: ${formatTimerTime(e.timerTime)} |
                                Focus: ${formatFocusTime(e.focusTime)} |
                                Unfocus: ${formatFocusTime(e.stopwatchTime)}${ratingDisplay}<br>
                                <small>${new Date(e.timestamp).toLocaleTimeString()}</small>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
            });
        }

        html += `</div>`;
    });

    cont.innerHTML=html;
}

/* EXPORT EXCEL */
function exportToExcel(){
    const data = focusHistory.map(e=>({
        Date: new Date(e.timestamp).toLocaleDateString(),
        Time: new Date(e.timestamp).toLocaleTimeString(),
        Prayer_Time: e.prayerTime,
        Category: e.category,
        Task: e.task,
        Timer_Seconds: e.timerTime,
        Unfocused_CS: e.stopwatchTime,
        Focus_CS: e.focusTime,
        Rating: e.rating !== undefined ? e.rating : '',
        Task_Completed: e.taskCompleted ? 'YES' : 'NO'
    }));
    const sheet = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,sheet,"Focus_History");
    XLSX.writeFile(wb,"focus-history.xlsx");
}

/* CLEAR */
function clearAllData(){
    if(confirm("Delete ALL sessions?")){
        focusHistory=[];
        expandedDays={};
        expandedPrayerTimes={};
        renderHistory();
    }
}

/* VIEW SWITCHING */
function switchToTimebox(){
    document.getElementById('timerView').classList.add('hidden');
    document.getElementById('timeboxView').classList.remove('hidden');
    generateTimeSlots();
}

function switchToTimer(){
    document.getElementById('timerView').classList.remove('hidden');
    document.getElementById('timeboxView').classList.add('hidden');
}

/* TIMEBOX */
function generateTimeSlots(){
    const box=document.getElementById('timeSlotsContainer');
    const today=new Date().toDateString();
    
    const prayerOrder = ['Fajr', 'Post Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const prayerSessions = {};
    
    prayerOrder.forEach(p => prayerSessions[p] = []);
    
    focusHistory.forEach(e=>{
        const d=new Date(e.timestamp);
        if(d.toDateString()===today){
            const prayer = e.prayerTime;
            if(prayerSessions[prayer]){
                prayerSessions[prayer].push(e);
            }
        }
    });
    
    let html = '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-around;">';
    
    prayerOrder.forEach(prayer => {
        const sessions = prayerSessions[prayer];
        html+=`
            <div style="border:1px solid #374151;padding:12px;flex:1;min-width:150px;max-width:200px;">
                <strong style="display:block;margin-bottom:8px;text-align:center;">${prayer}</strong>
        `;
        if(sessions.length > 0){
            sessions.forEach(s=>{
                html+=`
                    <div style="margin-top:6px;font-size:0.85rem;">
                        <span class="category-badge ${getCategoryClass(s.category)}">${s.category}</span>
                        <div style="margin-top:2px;">${s.task}</div>
                        <div style="font-size:0.75rem;color:#9ca3af;">Focus: ${formatFocusTime(s.focusTime)}</div>
                    </div>
                `;
            });
        } else {
            html += '<div style="color:#6b7280;font-size:0.85rem;text-align:center;">No sessions</div>';
        }
        html+="</div>";
    });
    
    html += '</div>';
    box.innerHTML=html;
}

/* COUNTDOWN TIMERS */
function updateCountdowns(){
    const now=new Date();

    const target=new Date('2026-04-03T00:00:00');
    const d1=target-now;
    if(d1>0){
        const ds=Math.floor(d1/(1000*60*60*24));
        const hs=Math.floor((d1%(1000*60*60*24))/(1000*60*60));
        const ms=Math.floor((d1%(1000*60*60))/ (1000*60));
        const ss=Math.floor((d1%(1000*60))/1000);
        document.getElementById('countdown1').textContent = `${ds}d ${hs}:${ms.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    const nm = new Date(now.getFullYear(),now.getMonth()+1,3);
    const d2 = nm-now;
    if(d2>0){
        const ds=Math.floor(d2/(1000*60*60*24));
        const hs=Math.floor((d2%(1000*60*60*24))/(1000*60*60));
        const ms=Math.floor((d2%(1000*60*60))/ (1000*60));
        const ss=Math.floor((d2%(1000*60))/1000);
        document.getElementById('countdown2').textContent = `${ds}d ${hs}:${ms.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }
}

function init(){
    updateCountdowns();
    setInterval(updateCountdowns,1000);
    renderHistory();
}
document.addEventListener('DOMContentLoaded', init);

</script>

</body>
</html>